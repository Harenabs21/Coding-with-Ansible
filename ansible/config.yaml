- name: Déploiement des sites et génération automatique de noms de domaines
  hosts: localhost
  become: true
  vars:
   site_content: "<html><body><h1>Voici mon site</h1></body></html>"
    domains:
     - front.hei.school
     - back.hei.school
     - api.hei.school
  tasks:
   - name: Créer les répertoires des sites
     file:
       path: "/var/www/{{ item }}"
       state: directory
     loop: "{{ domains }}"

   - name: Copier les contenus du site
     copy:
       content: "{{ site_content }}"
       dest: "/var/www/{{ item }}/index.html"
     loop: "{{ domains }}"

   - name: Générer les fichiers de configurations Apache2
     template:
       src: "virtual_host.conf.j2"
       dest: "/etc/apache2/sites-available/{{ item | regex_replace('\\.conf$', '') }}.conf"
     loop: "{{ domains }}"
     notify: Reload Apache2
   - name: Activer les sites Apache2
     file:
       src: "/etc/apache2/sites-available/{{ item }}.conf"
       dest: "/etc/apache2/sites-enabled/{{ item }}.conf"
       state: link
     loop: "{{ domains }}"
     notify: Reload Apache2
   - name: Activer les sites Apache2 avec a2ensite
     command: a2ensite {{ item }}
     loop: "{{ domains }}"
     notify: Reload Apache2


  handlers:
    - name: Reload Apache2
      service:
        name: apache2
        state: reloaded
